<project name="jSCEP" default="main">
	<typedef resource="org/tigris/subversion/svnant/svnantlib.xml">
		<classpath>
			<fileset dir="lib">
				<include name="svnant.jar"/>
				<include name="svnClientAdapter.jar"/>
			</fileset>
		</classpath>
	</typedef>
	<property file="branch.properties"/>
	<property name="src.output" value="bin/main"/>
	<property name="test.output" value="bin/test"/>
	<property name="src" value="src/main"/>
	<property name="test" value="src/test"/>
	<property name="docs" value="doc"/>
	
	<target name="main" depends="init, compile, compress, test, javadoc-archive, source-archive">
	</target>
	
	<target name="init">
		<mkdir dir="${src.output}"/>
		<mkdir dir="${test.output}"/>
		<mkdir dir="${docs}"/>
		<svn javahl="false" svnkit="false">
			<wcversion path="${basedir}" prefix="svn."/>
		</svn>
		<property name="build.number" value="${major.version}.${minor.version}.${svn.revision.max}"/>
		<tstamp>
			<format property="TODAY" pattern="yyyy-MM-dd" locale="en,GB"/>
		</tstamp>
	</target>
	
	<target name="compile">
		<javac srcdir="${src}" destdir="${src.output}" source="5">
			<classpath>
				<fileset dir="lib">
    				<include name="bcmail-jdk16-144.jar"/>
					<include name="bcprov-jdk16-144.jar"/>
				</fileset>
			</classpath>
		</javac>
	</target>
	
	<target name="test" depends="test-compile">
		<junit fork="true">
			<formatter type="plain"/>
			<classpath>
				<path path="${test.output}"/>
				<fileset dir="${src.output}">
					<include name="jSCEP-${build.number}.jar"/>
				</fileset>
				<fileset dir="lib">
    				<include name="bcmail-jdk16-144.jar"/>
					<include name="bcprov-jdk16-144.jar"/>
					<include name="junit-4.7.jar"/>
				</fileset>
			</classpath>
			<batchtest>
				<fileset dir="${test.output}">
					<include name="**/*.class"/>
				</fileset>
			</batchtest>
		</junit>
	</target>
	
	<target name="test-compile" depends="compile">
		<javac srcdir="${test}" destdir="${test.output}" source="5">
			<classpath>
				<fileset dir="${src.output}">
					<include name="jSCEP-${build.number}.jar"/>
				</fileset>
				<fileset dir="lib">
    				<include name="bcmail-jdk16-144.jar"/>
					<include name="bcprov-jdk16-144.jar"/>
					<include name="junit-4.7.jar"/>
				</fileset>
			</classpath>
		</javac>
	</target>

	<target name="javadoc">
		<javadoc destdir="${docs}" access="public">
			<fileset dir="${src}">
				<include name="**/*.java"/>
			</fileset>
			<classpath>
				<fileset dir="lib">
    				<include name="bcmail-jdk16-144.jar"/>
					<include name="bcprov-jdk16-144.jar"/>
				</fileset>
			</classpath>
		</javadoc>
	</target>

	<target name="source-archive">
		<jar destfile="${src.output}/jSCEP-source-${build.number}.jar" basedir="${src}" includes="**/*.java">
			<manifest>
				<attribute name="Built-By" value="${user.name}"/>
				<attribute name="Built-On" value="${TODAY}"/>
			</manifest>
		</jar>
	</target>	

	<target name="javadoc-archive" depends="javadoc">
		<jar destfile="${src.output}/jSCEP-docs-${build.number}.jar" basedir="${docs}" includes="**/*">
			<manifest>
				<attribute name="Built-By" value="${user.name}"/>
				<attribute name="Built-On" value="${TODAY}"/>
			</manifest>
		</jar>
	</target>
	
	<target name="compress">
		<jar destfile="${src.output}/jSCEP-${build.number}.jar">
			<fileset dir="${src.output}">
				<include name="**/*.class"/>
			</fileset>
			<fileset dir="${basedir}">
				<include name="COPYRIGHT"/>
			</fileset>
			<manifest>
				<attribute name="Specification-Title" value="SCEP"/>
				<attribute name="Specification-Version" value="${scep.specification}"/>
				<attribute name="Specification-Vendor" value="Cisco"/>
				<attribute name="Implementation-Title" value="jSCEP"/>
				<attribute name="Implementation-Version" value="${build.number}"/>
				<attribute name="Implementation-Vendor" value="David Grant"/>
				<attribute name="Implementation-Vendor-Id" value="com.google.code.jscep"/>
				<attribute name="Implementation-URL" value="http://jscep.googlecode.com/"/>
			</manifest>
		</jar>
	</target>
</project>
